---
title: "All_Discharge"
author: "tomchaffey"
date: "`r Sys.Date()`"
output: html_document
---

# Discharge and Phytoplankton Combined

While we've made good progress looking at both individually, and pilot tested a semi-working ARIMAX, its time to bring it all together and start zooming out. We're going to be using this markdown just to extract everything we need in a clean way, for posterity.

### Loading Packages

```{r, include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(data.table)
library(arsenal)
library(forecast)
library(xts)
library(dygraphs)
library(zoo)
library(tsibble)
library(gganimate)
library(viridis)
library(viridisLite)
```

### Extracting data

```{r, include=FALSE}
BALRANALD <- read_csv("Murray_Discharge/BALRANALD.csv")
  BALRANALD <- BALRANALD %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BALRANALD" = "Value") %>%
    select("Date_Sampled", "BALRANALD")
   
BURTUNDY<- read_csv("Murray_Discharge/BURTUNDY.csv")
  BURTUNDY <- BURTUNDY %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BURTUNDY" = "Value") %>%
    select("Date_Sampled", "BURTUNDY")
   
HEYWOODS<- read_csv("Murray_Discharge/HEYWOODS.csv")
  HEYWOODS <- HEYWOODS %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("HEYWOODS" = "Value") %>%
    select("Date_Sampled", "HEYWOODS")
   
LOCK_9<- read_csv("Murray_Discharge/LOCK_9.csv")
  LOCK_9 <- LOCK_9 %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("LOCK 9" = "Value") %>%
    select("Date_Sampled", "LOCK 9")
   
MERBEIN<- read_csv("Murray_Discharge/MERBEIN.csv")
  MERBEIN <- MERBEIN %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("MERBEIN" = "Value") %>%
    select("Date_Sampled", "MERBEIN")
   
SWAN_HILL<- read_csv("Murray_Discharge/SWAN_HILL.csv")
  SWAN_HILL<- SWAN_HILL %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("SWAN HILL" = "Value") %>%
    select("Date_Sampled", "SWAN HILL")
   
YARRAWONGA<- read_csv("Murray_Discharge/YARRAWONGA.csv")
  YARRAWONGA <- YARRAWONGA %>%
   rename("Date_Sampled" = "#Timestamp") %>%
     rename("YARRAWONGA" = "Value") %>%
    select("Date_Sampled", "YARRAWONGA")
  
discharge_list <- list(MERBEIN, LOCK_9, YARRAWONGA, SWAN_HILL, HEYWOODS, BALRANALD, BURTUNDY) 

discharge_all <- discharge_list %>%
  reduce(full_join, by = "Date_Sampled")

discharge_all$Date_Sampled <- as.Date(discharge_all$Date_Sampled, tz = "")

discharge_all <- discharge_all %>%
  gather(key= SITENAME, value = Value, 2:8)

```

This is all our discharge data combined in one file, from 1979 to 2022, with variables for each site that contains (mostly) continuous data.

```{r, include=FALSE}
Phyto_AWQC <- read_csv("PMP Data/Phyto_AWQC_FIXED.csv")

Phyto_AWQC <- Phyto_AWQC %>% 
  mutate(Date_Sampled = as.Date(DATESAMPLED, format= "%d/%m/%y")) %>%
  select(-DATESAMPLED, -COMMENTS, -SampleID, -ResultID, -ID, -OTHERID) %>%
  drop_na(CELLCOUNT) %>%
  filter(SITENAME == "LOCK 9" | 
           SITENAME == "YARRAWONGA" |
           SITENAME == "BURTUNDY" |
           SITENAME == "MERBEIN" |
           SITENAME == "SWAN HILL" |
           SITENAME == "BALRANALD" |
           SITENAME == "HEYWOODS" |
           SITENAME == "MORGAN") 

```

```{r}
# Combining DFs
df.combined <- full_join(Phyto_AWQC, discharge_all)

df.combined <- df.combined %>%
  drop_na(Value)
df.combined <- df.combined %>%
   drop_na(CELLCOUNT) %>%
  mutate(log_CELLCOUNT = log10(CELLCOUNT)) %>%
  mutate(log_Discharge = log10(Value))


df.combined <- df.combined %>%
  mutate(MonthYear = paste(year(Date_Sampled), formatC(month(Date_Sampled), width = 2, flag = "0")))
df.combined <- df.combined %>%
  mutate(Week = week(Date_Sampled))
  )
```

This works for joining df's, however it drops Lock 9, variables musn't be named the same.

```{r}
df.combined %>%
  group_by(SITENAME, TAXA) %>%
  summarise(
    Cellcount = mean(CELLCOUNT),
    Discharge = mean(Value)
  )
```

```{r}
# not necessary, ignore
df.combined$Date_Sampled <- as.POSIXct(df.combined$Date_Sampled)
df.combined <- mutate(df.combined, MonthYear = paste(year(Date_Sampled), formatC(month(Date_Sampled), width = 2, flag = "0")))
df.combined <- mutate(df.combined, Week = week(Date_Sampled))
df.month_cell <- aggregate(df.combined$CELLCOUNT, by = list(df.combined$MonthYear), FUN = function(x) mean(x, na.rm=T))
df.month_discharge <- aggregate(df.combined$Value, by = list(df.combined$MonthYear), FUN = function(x) mean(x, na.rm=T))


  
```

### Subsetting for Presentation and ARIMAX

Now got a complete data set which contains indexed dates, discharge values, site names and cell counts. Unfortunately, once all this cleaning is done, we're left with a set of about 23,000 observations.

Plots for each Site and total algae.

```{r}
# Summary statistics
df.combined %>%
  group_by(SITENAME) %>%
  summarise(
    n_distinct(TAXA),
    sum(CELLCOUNT)
  )

df.combined %>%
  group_by(TAXA) %>%
  summarise(
    sum(CELLCOUNT)
  )
```

### Messing with algae

```{r}
# Playing with algae
algae_df <- df.combined %>%
  filter(SITENAME == "LOCK 9",
          TAXA == "Algae - Total")
algae.ts <- algae_df %>%
  select(log_CELLCOUNT) %>%
  ts(start = c(1997,11), frequency = 80)

d_algae.ts <- algae_df %>%
  select(log_Discharge) %>%
  ts(start = c(1997,11), frequency =  80)

plot.ts(algae.ts)
plot.ts(d_algae.ts)

```

# Subsetting out df's for analysis

### Heywoods - DONE

```{r}
Heywoods.df <- df.combined %>%
  filter(SITENAME =="HEYWOODS")
min(Heywoods.df$Date_Sampled)
max(Heywoods.df$Date_Sampled)

Heywoods.df %>%
  group_by(TAXA) %>%
  summarise(CELLCOUNT) 

## Algae total, aulacoseira, b-g total 

hey_sum <- aggregate(x = Heywoods.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Heywoods.df$Date_Sampled))

heywoods_algae <- Heywoods.df %>%
  filter(TAXA =="Algae - Total")
    h_algae.ts <- ts(heywoods_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_algae_discharge <- ts(heywoods_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
heywoods_aulacoseira <- Heywoods.df %>%
  filter(TAXA == "Aulacoseira")
     h_aulacoseira.ts <- ts(heywoods_aulacoseira$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_aula_discharge <- ts(heywoods_aulacoseira$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
heywoods_bg <- Heywoods.df %>%
  filter(TAXA == "Blue Green Algae - Total")
    h_bg.ts <- ts(heywoods_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_bg_discharge <- ts(heywoods_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)


par(mfrow = c(1,3))
plot_algae <- plot(h_algae.ts)
plot_aulacoseira <- plot(h_aulacoseira.ts)
plot_bg <- plot(h_bg.ts)

par(mfrow = c(1,3))
plot_hd1 <- plot(h_algae_discharge)
plot_hd2 <- plot(h_aula_discharge)
plot_hd3 <- plot(h_bg_discharge)


```

###Yarrawonga - DONE

```{r}
Yarrawonga.df <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")

min(Yarrawonga.df$Date_Sampled)
max(Yarrawonga.df$Date_Sampled)

Yarrawonga.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

# Algae total, aphanocapsa, aulacoeira, bg total

yarra_sum <- aggregate(x = Yarrawonga.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Yarrawonga.df$Date_Sampled))

yarra_algae <- Yarrawonga.df %>%
  filter(TAXA =="Algae - Total")
    y_algae.ts <- ts(yarra_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_algae_discharge <- ts(yarra_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_aphanocapsa <- Yarrawonga.df %>%
  filter(TAXA =="Aphanocapsa")
    y_aphano.ts <- ts(yarra_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_aphanp_discharge <- ts(yarra_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_aula <- Yarrawonga.df %>%
  filter(TAXA =="Aulacoseira")
    y_aula.ts <- ts(yarra_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_aula_discharge <- ts(yarra_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_bg <- Yarrawonga.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    y_bg.ts <- ts(yarra_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_bg_discharge <- ts(yarra_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_y <- plot(y_algae.ts)
plot_aulacoseira_y <- plot(y_aula.ts)
plot_bg_y <- plot(y_bg.ts)
plot_aphano_y <- plot(y_aphano.ts)

par(mfrow = c(1,4))
plot_y1 <- plot(y_algae_discharge)
plot_y2 <- plot(y_aula_discharge)
plot_y3 <- plot(y_bg_discharge)
plot_y4 <- plot(y_aphanp_discharge)
```

###Merbein - DONE

```{r}
Merbein.df <- df.combined %>%
  filter(SITENAME == "MERBEIN")

min(Merbein.df$Date_Sampled)
max(Merbein.df$Date_Sampled)

Merbein.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))


#merbein sum 
merb_sum <- aggregate(x = Merbein.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Merbein.df$Date_Sampled))

merbein_algae <- Merbein.df %>%
  filter(TAXA =="Algae - Total")
    m_algae.ts <- ts(merbein_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_algae_discharge <- ts(merbein_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_aphanocapsa <- Merbein.df %>%
  filter(TAXA =="Aphanocapsa")
    m_aphano.ts <- ts(merbein_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_aphanp_discharge <- ts(merbein_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_aula <- Merbein.df %>%
  filter(TAXA =="Aulacoseira")
    m_aula.ts <- ts(merbein_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_aula_discharge <- ts(merbein_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_bg <- Merbein.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    m_bg.ts <- ts(merbein_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_bg_discharge <- ts(merbein_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_m <- plot(m_algae.ts)
plot_aulacoseira_m <- plot(m_aula.ts)
plot_bg_m <- plot(m_bg.ts)
plot_aphano_m <- plot(m_aphano.ts)

par(mfrow = c(1,4))
plot_m1 <- plot(m_algae_discharge)
plot_m2 <- plot(m_aula_discharge)
plot_m3 <- plot(m_bg_discharge)
plot_m4 <- plot(m_aphanp_discharge)
```

###Swan Hill - DONE

```{r}
Swan_hill.df <- df.combined %>%
  filter(SITENAME == "SWAN HILL")

min(Swan_hill.df$Date_Sampled)
max(Swan_hill.df$Date_Sampled)

Swan_hill.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))


# swan sum
swan_sum <- aggregate(x = Swan_hill.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Swan_hill.df$Date_Sampled))

swan_algae <- Swan_hill.df %>%
  filter(TAXA =="Algae - Total")
    s_algae.ts <- ts(swan_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_algae_discharge <- ts(swan_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
swan_aphanocapsa <- Swan_hill.df %>%
  filter(TAXA =="Aphanocapsa")
    s_aphano.ts <- ts(swan_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_aphanp_discharge <- ts(swan_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
swan_aula <- Swan_hill.df %>%
  filter(TAXA =="Aulacoseira")
    s_aula.ts <- ts(swan_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_aula_discharge <- ts(swan_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
s_bg <- Swan_hill.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    s_bg.ts <- ts(s_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_bg_discharge <- ts(s_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_s <- plot(s_algae.ts)
plot_aulacoseira_s <- plot(s_aula.ts)
plot_bg_s <- plot(s_bg.ts)
plot_aphano_s <- plot(s_aphano.ts)

par(mfrow = c(1,4))
plot_s1 <- plot(s_algae_discharge)
plot_s2 <- plot(s_aula_discharge)
plot_s3 <- plot(s_bg_discharge)
plot_s4 <- plot(s_aphanp_discharge)
```

### Lock 9 - DONE

```{r}
Lock9.df <- df.combined %>%
  filter(SITENAME == "LOCK 9")

min(Lock9.df$Date_Sampled)
max(Lock9.df$Date_Sampled)

Lock9.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))


#l9 sum
L9sum <- aggregate(x = Lock9.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Lock9.df$Date_Sampled))

lock9_anabaena <- Lock9.df %>%
 filter(TAXA =="Algae - Total")
    l_anabaena.ts <- ts(lock9_anabaena$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_anabaena_discharge <- ts(lock9_anabaena$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_algae <- Lock9.df %>%
  filter(TAXA =="Algae - Total")
    l_algae.ts <- ts(lock9_algae$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_algae_discharge <- ts(lock9_algae$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_aphanocapsa <- Lock9.df %>%
  filter(TAXA =="Aphanocapsa")
    l_aphano.ts <- ts(lock9_aphanocapsa$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_aphanp_discharge <- ts(lock9_aphanocapsa$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_aula <- Lock9.df %>%
  filter(TAXA =="Aulacoseira")
    l_aula.ts <- ts(lock9_aula$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_aula_discharge <- ts(lock9_aula$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_bg <- Lock9.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    l_bg.ts <- ts(lock9_bg$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_bg_discharge <- ts(lock9_bg$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,5))
plot_anabaena <- plot(l_anabaena.ts)
plot_algae_l <- plot(l_algae.ts)
plot_aulacoseira_l <- plot(l_aula.ts)
plot_bg_l <- plot(l_bg.ts)
plot_aphano_l <- plot(l_aphano.ts)

par(mfrow = c(1,5))
plot_l <- plot(l_anabaena_discharge)
plot_l1 <- plot(l_algae_discharge)
plot_l2 <- plot(l_aula_discharge)
plot_l3 <- plot(l_bg_discharge)
plot_l4 <- plot(l_aphanp_discharge)
```

###Balranald - DONE

```{r}
Balranald.df <- df.combined %>%
  filter(SITENAME == "BALRANALD")

min(Balranald.df$Date_Sampled)
max(Balranald.df$Date_Sampled)

Balranald.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

#balranald sum 
bal_sum <- aggregate(x = Balranald.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Balranald.df$Date_Sampled))

balranald_algae <- Balranald.df %>%
  filter(TAXA =="Algae - Total")
    b_algae.ts <- ts(balranald_algae$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_algae_discharge <- ts(balranald_algae$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_aphanocapsa <- Balranald.df %>%
  filter(TAXA =="Aphanocapsa")
    b_aphano.ts <- ts(balranald_aphanocapsa$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_aphanp_discharge <- ts(balranald_aphanocapsa$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_aula <- Balranald.df %>%
  filter(TAXA =="Aulacoseira")
    b_aula.ts <- ts(balranald_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_aula_discharge <- ts(balranald_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_bg <- Balranald.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    b_bg.ts <- ts(balranald_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_bg_discharge <- ts(balranald_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_b <- plot(b_algae.ts)
plot_aulacoseira_b <- plot(b_aula.ts)
plot_bg_b <- plot(b_bg.ts)
plot_aphano_b <- plot(b_aphano.ts)

par(mfrow = c(1,4))
plot_b1 <- plot(b_algae_discharge)
plot_b2 <- plot(b_aula_discharge)
plot_b3 <- plot(b_bg_discharge)
plot_b4 <- plot(b_aphanp_discharge)
```

### Burtrundy - DONE

```{r}
Burtundy.df <- df.combined %>%
  filter(SITENAME == "BURTUNDY")

min(Burtundy.df$Date_Sampled)
max(Burtundy.df$Date_Sampled)

Burtundy.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

# burtundy sum 

bur_sum <- aggregate(x = Burtundy.df[c("Value", "CELLCOUNT")],
                   FUN = sum,
                   by = list(Group.date = Burtundy.df$Date_Sampled))

burtundy_algae <- Burtundy.df %>%
  filter(TAXA =="Algae - Total")
    bt_algae.ts <- ts(burtundy_algae$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_algae_discharge <- ts(burtundy_algae$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_aphanocapsa <- Burtundy.df %>%
  filter(TAXA =="Aphanocapsa")
    bt_aphano.ts <- ts(burtundy_aphanocapsa$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_aphanp_discharge <- ts(burtundy_aphanocapsa$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_aula <- Burtundy.df %>%
  filter(TAXA =="Aulacoseira")
    bt_aula.ts <- ts(burtundy_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_aula_discharge <- ts(burtundy_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_bg <- Burtundy.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    bt_bg.ts <- ts(burtundy_bg$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_bg_discharge <- ts(burtundy_bg$Value, start = c(2016), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_bt <- plot(bt_algae.ts)
plot_aulacoseira_bt <- plot(bt_aula.ts)
plot_bg_bt <- plot(bt_bg.ts)
plot_aphano_bt <- plot(bt_aphano.ts)

par(mfrow = c(1,4))
plot_bt1 <- plot(bt_algae_discharge)
plot_bt2 <- plot(bt_aula_discharge)
plot_bt3 <- plot(bt_bg_discharge)
plot_bt4 <- plot(bt_aphanp_discharge)
```

### First working ARIMA for total c-b Lock 9

```{r}
head(L9sum)
total_l9_ts <- ts(log10(L9sum$CELLCOUNT), start = c(1997, 11), frequency = 52)
total_l9d_ts <- ts(L9sum$Value, start =c(1997, 11), frequency = 52)
par(mfrow = c(1,2))
plot(total_l9_ts)
plot(total_l9d_ts)
fit1 <- auto.arima(total_l9_ts)
fit1
plot(forecast(fit1, h  = 52))
### making xregs for l9 discharge ... cmon baby 

l9_train = L9sum[1:801,]
l9_test = L9sum[802:1003,]
discharge.train = ts(l9_train$Value, 
                     frequency = 45,
                     start = c(1996, 11))
cell_train = ts(log10(l9_train$CELLCOUNT),
                frequency = 45,
                start = c(1997, 11))
discharge.test = ts(l9_test$Value,
                    frequency = 45,
                    start = c(2015, 06)) # test and train should be 80/20 of the vector 
Observed_Results = ts(log10(l9_test$CELLCOUNT), 
               frequency = 45,
               start= c(2015, 06))
fitrain <- auto.arima(cell_train, 
                      xreg = discharge.train)
train.fc <- forecast(fitrain,
                     xreg = discharge.test)
plot(train.fc)
# with observed 
autoplot(train.fc) + autolayer(Observed_Results)
plot(forecast(auto.arima(log10(L9sum$CELLCOUNT)), 
              h = 45))
train.fc
fitrain

autoplot(train.fc) + 
  autolayer(Observed_Results) +
  theme_ipsum() + 
  labs(x = "Date",
       y = "Log10 Cellcount",
       title = "ARIMA (0,1,0) Forecast at Lock 9")

# this appears to be a working ARIMA model, with discharge covariates used in forecasting. Model doesnt seem great, infact, pretty bad, but this is to be expected given the range of factors that influence abundance. Discharge is one component (many others nested within)
```

# ARIMAX forecast - ALL
Yarrawonga
```{r}
# Yarrawonga Sum -ARIMA 
length(yarra_sum$CELLCOUNT)
min(yarra_sum$Group.date)
max(yarra_sum$Group.date)
yarra_train <- yarra_sum[1:120,]
yarra_test <- yarra_sum[121:151,]
y_dc.train <- ts(yarra_train$Value,
                 frequency = 45,
                 start = c(2016,7))
y_cell.train <- ts(log10(yarra_train$CELLCOUNT),
                   frequency = 45,
                   start = c(2016,7))
y_dc.test <- ts(yarra_test$Value,
                   frequency = 45,
                   start = c(2019,1))
Yarrawonga_Observed <- ts(log10(yarra_test$CELLCOUNT),
                   frequency = 45,
                   start = c(2018.8))

fit_yarra <- auto.arima(y_cell.train,
                        xreg = y_dc.train)
yarra.fc <- forecast(fit_yarra,
                     xreg = y_dc.test
                     )
plot(yarra.fc)

autoplot(yarra.fc) + 
  autolayer(Yarrawonga_Observed) +
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "log10 Cellcount",
       title ="ARIMA (0,1,0) Forecast at Yarrawonga")

acf(yarra_sum$CELLCOUNT)
pacf(yarra_sum$CELLCOUNT)

fity <- auto.arima(yarra_train$CELLCOUNT)
forecast.y <- forecast(fity)
plot(forecast.y)



summary(yarra.fc)
summary(forecast.y)
```
Swan Hill
```{r}
length(swan_sum$CELLCOUNT)
min(swan_sum$Group.date)
max(swan_sum$Group.date)
swan_train <- swan_sum[1:127,]
swan_test <- swan_sum[128:159,]
s_dc.train <- ts(swan_train$Value,
                 frequency = 45,
                start =c(2016))
s_cell.train <- ts(swan_train$CELLCOUNT,
                   frequency = 45,
                   start =c(2016))
s_dc.test <- ts(swan_test$Value,
                   frequency = 45,
                   start =c(2018.8))
SwanHill_Observed <- ts(swan_test$CELLCOUNT,
                   frequency = 45,
                   start = c(2018.8))

fit_swanhill <- auto.arima(s_cell.train,
                        xreg = s_dc.train)
swanhill.fc <- forecast(fit_swanhill,
                     xreg = s_dc.test
                     )
plot(swanhill.fc)

autoplot(swanhill.fc) + 
  autolayer(SwanHill_Observed) + 
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "log10 Cellcount",
       title = "ARIMA (0,1,1) Forecasts at Yarrawonga")

acf(swan_sum$CELLCOUNT)
pacf(swan_sum$CELLCOUNT)

fitsh <- auto.arima(swan_train$CELLCOUNT)
forecastsh <- forecast(fitsh)
plot(forecastsh)
summary(forecastsh)


summary(forecastsh)
summary(swanhill.fc)

```
Heywoods
```{r}
length(hey_sum$CELLCOUNT)
min(hey_sum$Group.date)
max(hey_sum$Group.date)
hey_train <- hey_sum[1:127,]
hey_test <- hey_sum[128:159,]
h_dc.train <- ts(hey_train$Value,
                 frequency = 45,
                 )
h_cell.train <- ts(hey_train$CELLCOUNT,
                   frequency = 45,
                   )
h_dc.test <- ts(hey_test$Value,
                   frequency = 45,
                   )
Heywoods_Observed <- ts(hey_test$CELLCOUNT,
                   frequency = 45,
                   start = c(3.8))

fit_heywoods <- auto.arima(h_cell.train,
                        xreg = h_dc.train)
heywoods.fc <- forecast(fit_heywoods,
                     xreg = h_dc.test
                     )
plot(heywoods.fc)

autoplot(heywoods.fc) + 
  autolayer(Heywoods_Observed)

autoplot(heywoods.fc) + 
  autolayer(Heywoods_Observed) +
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "log10 Cellcount",
       title = "ARIMA (0,1,2) Forecasts at Heywood")


acf(hey_sum$CELLCOUNT)
pacf(hey_sum$CELLCOUNT)

fith <- auto.arima(hey_train$CELLCOUNT)
plot(forecast(fith))
```
Merbein
```{r}
length(merb_sum$CELLCOUNT)
min(merb_sum$Group.date)
max(merb_sum$Group.date)
merb_train <- hey_sum[1:115,]
merb_test <- hey_sum[116:145,]
m_dc.train <- ts(merb_train$Value,
                 frequency = 45,
                 )
m_cell.train <- ts(merb_train$CELLCOUNT,
                   frequency = 45,
                   )
m_dc.test <- ts(merb_test$Value,
                   frequency = 45,
                   )
Merbein_Observed <- ts(merb_test$CELLCOUNT,
                   frequency = 45,
                   start =c(3.54))

fit_Merbein <- auto.arima(m_cell.train,
                        xreg = m_dc.train)
merbein.fc <- forecast(fit_Merbein,
                     xreg = m_dc.test
                     )
plot(merbein.fc)

autoplot(merbein.fc) + 
  autolayer(Merbein_Observed) +
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "log10 Cellcount",
       title = "ARIMA (1,1,1,) Forecasts at Merbein")

acf(merb_sum$CELLCOUNT)
pacf(merb_sum$CELLCOUNT)

fitm <- auto.arima(merb_train$CELLCOUNT)
plot(forecast(fitm))
```
Burtundy
```{r}
length(bur_sum$CELLCOUNT)
min(bur_sum$Group.date)
max(bur_sum$Group.date)
bur_train <- bur_sum[1:116,]
bur_test <- bur_sum[117:147,]
b_dc.train <- ts(bur_train$Value,
                 frequency = 45,
                 )
b_cell.train <- ts(bur_train$CELLCOUNT,
                   frequency = 45,
                   )
b_dc.test <- ts(bur_test$Value,
                   frequency = 45,
                   )
Burtundy_Observed <- ts(bur_test$CELLCOUNT,
                   frequency = 45,
                   start =c(3.59))

fit_Burtundy <- auto.arima(b_cell.train,
                        xreg = b_dc.train)
burtundy.fc <- forecast(fit_Burtundy,
                     xreg = b_dc.test
                     )
plot(burtundy.fc)

autoplot(burtundy.fc) + 
  autolayer(Burtundy_Observed) +
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "Log10 Cellcount",
       title = "ARIMA (1,0,3) Forecasts at Burtundy")

  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "log10 Cellcount",
       title = "ARIMA (0,1,1) Forecasts at Yarrawonga")

acf(bur_sum$CELLCOUNT)
pacf(bur_sum$CELLCOUNT)

fitb <- auto.arima(bur_train$CELLCOUNT)
plot(forecast(fitb))
```
Balranald
```{r}
length(bal_sum$CELLCOUNT)
min(bal_sum$Group.date)
max(bal_sum$Group.date)
bal_train <- bal_sum[1:123,]
bal_test <- bal_sum[124:156,]
bal_dc.train <- ts(bal_train$Value,
                 frequency = 45,
                 )
bal_cell.train <- ts(bal_train$CELLCOUNT,
                   frequency = 45,
                   )
bal_dc.test <- ts(bal_test$Value,
                   frequency = 45,
                   )
Balranald_Observed <- ts(bal_test$CELLCOUNT,
                   frequency = 45,
                   start =c(3.7))

fit_Balranald <- auto.arima(bal_cell.train,
                        xreg = bal_dc.train)
Balranald.fc <- forecast(fit_Balranald,
                     xreg = bal_dc.test
                     )
plot(Balranald.fc)

autoplot(Balranald.fc) + 
  autolayer(Balranald_Observed)

autoplot(Balranald.fc) + 
  autolayer(Balranald_Observed) +
  theme_ipsum() +
  scale_y_log10() +
  labs(x = "Date",
       y = "Log10 Cellcount",
       title = "ARIMA (0,1,1) Forecasts at Balranald")

acf(bal_sum$CELLCOUNT)
pacf(bal_sum$CELLCOUNT)

fitbal <- auto.arima(bal_train$CELLCOUNT)
fitbal1 <-plot(forecast(fitbal))
```

