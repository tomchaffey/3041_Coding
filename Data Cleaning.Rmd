---
title: "All_Discharge"
author: "tomchaffey"
date: "`r Sys.Date()`"
output: html_document
---

# Discharge and Phytoplankton Combined

While we've made good progress looking at both individually, and pilot tested a semi-working ARIMAX, its time to bring it all together and start zooming out. We're going to be using this markdown just to extract everything we need in a clean way, for posterity.

### Loading Packages

```{r, include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(data.table)
library(arsenal)
library(forecast)
library(xts)
library(dygraphs)
```

### Extracting data

```{r, include=FALSE}
BALRANALD <- read_csv("Murray_Discharge/BALRANALD.csv")
  BALRANALD <- BALRANALD %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BALRANALD" = "Value") %>%
    select("Date_Sampled", "BALRANALD")
   
BURTUNDY<- read_csv("Murray_Discharge/BURTUNDY.csv")
  BURTUNDY <- BURTUNDY %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BURTUNDY" = "Value") %>%
    select("Date_Sampled", "BURTUNDY")
   
HEYWOODS<- read_csv("Murray_Discharge/HEYWOODS.csv")
  HEYWOODS <- HEYWOODS %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("HEYWOODS" = "Value") %>%
    select("Date_Sampled", "HEYWOODS")
   
LOCK_9<- read_csv("Murray_Discharge/LOCK_9.csv")
  LOCK_9 <- LOCK_9 %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("LOCK 9" = "Value") %>%
    select("Date_Sampled", "LOCK 9")
   
MERBEIN<- read_csv("Murray_Discharge/MERBEIN.csv")
  MERBEIN <- MERBEIN %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("MERBEIN" = "Value") %>%
    select("Date_Sampled", "MERBEIN")
   
SWAN_HILL<- read_csv("Murray_Discharge/SWAN_HILL.csv")
  SWAN_HILL<- SWAN_HILL %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("SWAN HILL" = "Value") %>%
    select("Date_Sampled", "SWAN HILL")
   
YARRAWONGA<- read_csv("Murray_Discharge/YARRAWONGA.csv")
  YARRAWONGA <- YARRAWONGA %>%
   rename("Date_Sampled" = "#Timestamp") %>%
     rename("YARRAWONGA" = "Value") %>%
    select("Date_Sampled", "YARRAWONGA")
  
discharge_list <- list(MERBEIN, LOCK_9, YARRAWONGA, SWAN_HILL, HEYWOODS, BALRANALD, BURTUNDY) 

discharge_all <- discharge_list %>%
  reduce(full_join, by = "Date_Sampled")

discharge_all$Date_Sampled <- as.Date(discharge_all$Date_Sampled, tz = "")

discharge_all <- discharge_all %>%
  gather(key= SITENAME, value = Value, 2:8)

```

This is all our discharge data combined in one file, from 1979 to 2022, with variables for each site that contains (mostly) continuous data.

```{r, include=FALSE}
Phyto_AWQC <- read_csv("PMP Data/Phyto_AWQC_FIXED.csv")

Phyto_AWQC <- Phyto_AWQC %>% 
  mutate(Date_Sampled = as.Date(DATESAMPLED, format= "%d/%m/%y")) %>%
  select(-DATESAMPLED, -COMMENTS, -SampleID, -ResultID, -ID, -OTHERID) %>%
  drop_na(CELLCOUNT) %>%
  filter(SITENAME == "LOCK 9" | 
           SITENAME == "YARRAWONGA" |
           SITENAME == "BURTUNDY" |
           SITENAME == "MERBEIN" |
           SITENAME == "SWAN HILL" |
           SITENAME == "BALRANALD" |
           SITENAME == "HEYWOODS" |
           SITENAME == "MORGAN")

```

```{r}
a <- full_join(Phyto_AWQC, discharge_all)

b <- a %>%
  drop_na(Value)
df.combined <- b %>%
   drop_na(CELLCOUNT)
```

This works for joining df's, however it drops Lock 9, variables musn't be named the same.

```{r}
df.combined %>%
  group_by(SITENAME, TAXA) %>%
  summarise(
    Cellcount = mean(CELLCOUNT),
    Discharge = mean(Value)
  )
```
### Subsetting for Presentation and ARIMAX

Now got a complete data set which contains indexed dates, discharge values, site names and cell counts. Unfortunately, once all this cleaning is done, we're left with a set of about 23,000 observations. 

Plots for each Site and total algae. 

```{r}
df.combined %>% 
  filter(SITENAME == "YARRAWONGA") %>%
  ggplot(aes(Date_Sampled, CELLCOUNT)) +
  geom_point() +
  scale_y_log10() + 
  labs(x = "Date",
       y = "Cellcount (cells/mL)",
       title = "Total Phytoplankton at Lock 9")
```


```{r}
p_yarra.xts <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")


pplot_yarra.xts<- xts(p_yarra.xts$CELLCOUNT, order.by = p_yarra.xts$Date_Sampled)
dygraph(pplot_yarra.xts, main = "Phytoplankton Abundance at Yarrawaonga", ylab = "Cells/mL")

d_yarra.xts <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")

dplot_yarra.xts <- xts(d_yarra.xts$Value, order.by = d_yarra.xts$Date_Sampled)
dygraph(dplot_yarra.xts, main = "Discharge at Yarrawonga", ylab = "Discharge [cumec]")
```

```{r}
dvp_lock <- df.combined %>%
  filter(SITENAME =="LOCK 9") %>%
  filter(grepl("Anabaena", TAXA)) %>%
  select(TAXA, SITENAME, Value, CELLCOUNT, Date_Sampled)


ggplot(dvp_lock, aes(Value, CELLCOUNT)) +
  geom_point()
```
```{r}
discharge.lm <- lm(CELLCOUNT ~ Value, data = dvp_lock)
summary(discharge.lm)
plot(discharge.lm)
plot(CELLCOUNT ~ Value,data = dvp_lock)
```
```{r}
df.combined %>%
  group_by(SITENAME) %>%
  summarise(
    n_distinct(TAXA),
    sum(CELLCOUNT)
  )

df.combined %>%
  group_by(TAXA) %>%
  summarise(
    sum(CELLCOUNT)
  )
```
Algae - total. 

```{r}
algae_df <- df.combined %>%
  filter(SITENAME == "MERBEIN",
          TAXA == "Algae - Total")
```


```{r}
p_algae.xts <- xts(algae_df$CELLCOUNT, order.by = algae_df$Date_Sampled)
d_algae.xts <- xts(algae_df$Value, order.by = algae_df$Date_Sampled)

pd_algae.xts <- cbind(p_algae.xts, d_algae.xts)

dygraph(p_algae.xts, main ="Phytoplankton")
dygraph(d_algae.xts, main = "Discharge")
```


```{r, include=FALSE}
algae.ts <- algae_df %>%
  select(CELLCOUNT) %>%
  ts(start = 2016, frequency = 52)

d_algae.ts <- algae_df %>%
  select(Value) %>%
  ts(start = 2016, frequency =  52)
plot(algae.ts)
plot(d_algae.ts)

```
```{r}
merbein <- function(algae.ts, h, d_algae.ts) {
  ncol <- NCOL(d_algae.ts)
  X <- matrix(xreg[seq_along(algae.ts), ], ncol = ncol)
  if (NROW(d_algae.ts) < length(algae.ts) + h) {
    stop("Not enough xreg data")
  }
  newX <- matrix(d_algae.ts[length(algae.ts) + seq(h), ], ncol = ncol)
  algae_m <- auto.arima(algae.ts, xreg = X)
  forecast(algae_m, xreg = newX, h = 20)
}
```


```{r}
plot(forecast(algae_m, xreg = newX, h =20))
```



