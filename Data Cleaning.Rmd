---
title: "All_Discharge"
author: "tomchaffey"
date: "`r Sys.Date()`"
output: html_document
---

# Discharge and Phytoplankton Combined

While we've made good progress looking at both individually, and pilot tested a semi-working ARIMAX, its time to bring it all together and start zooming out. We're going to be using this markdown just to extract everything we need in a clean way, for posterity.

### Loading Packages

```{r, include=FALSE}
library(tidyverse)
library(dplyr)
library(lubridate)
library(data.table)
library(arsenal)
library(forecast)
library(xts)
library(dygraphs)
```

### Extracting data

```{r, include=FALSE}
BALRANALD <- read_csv("Murray_Discharge/BALRANALD.csv")
  BALRANALD <- BALRANALD %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BALRANALD" = "Value") %>%
    select("Date_Sampled", "BALRANALD")
   
BURTUNDY<- read_csv("Murray_Discharge/BURTUNDY.csv")
  BURTUNDY <- BURTUNDY %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("BURTUNDY" = "Value") %>%
    select("Date_Sampled", "BURTUNDY")
   
HEYWOODS<- read_csv("Murray_Discharge/HEYWOODS.csv")
  HEYWOODS <- HEYWOODS %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("HEYWOODS" = "Value") %>%
    select("Date_Sampled", "HEYWOODS")
   
LOCK_9<- read_csv("Murray_Discharge/LOCK_9.csv")
  LOCK_9 <- LOCK_9 %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("LOCK 9" = "Value") %>%
    select("Date_Sampled", "LOCK 9")
   
MERBEIN<- read_csv("Murray_Discharge/MERBEIN.csv")
  MERBEIN <- MERBEIN %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("MERBEIN" = "Value") %>%
    select("Date_Sampled", "MERBEIN")
   
SWAN_HILL<- read_csv("Murray_Discharge/SWAN_HILL.csv")
  SWAN_HILL<- SWAN_HILL %>%
   rename("Date_Sampled" = "#Timestamp") %>%
    rename("SWAN HILL" = "Value") %>%
    select("Date_Sampled", "SWAN HILL")
   
YARRAWONGA<- read_csv("Murray_Discharge/YARRAWONGA.csv")
  YARRAWONGA <- YARRAWONGA %>%
   rename("Date_Sampled" = "#Timestamp") %>%
     rename("YARRAWONGA" = "Value") %>%
    select("Date_Sampled", "YARRAWONGA")
  
discharge_list <- list(MERBEIN, LOCK_9, YARRAWONGA, SWAN_HILL, HEYWOODS, BALRANALD, BURTUNDY) 

discharge_all <- discharge_list %>%
  reduce(full_join, by = "Date_Sampled")

discharge_all$Date_Sampled <- as.Date(discharge_all$Date_Sampled, tz = "")

discharge_all <- discharge_all %>%
  gather(key= SITENAME, value = Value, 2:8)

```

This is all our discharge data combined in one file, from 1979 to 2022, with variables for each site that contains (mostly) continuous data.

```{r, include=FALSE}
Phyto_AWQC <- read_csv("PMP Data/Phyto_AWQC_FIXED.csv")

Phyto_AWQC <- Phyto_AWQC %>% 
  mutate(Date_Sampled = as.Date(DATESAMPLED, format= "%d/%m/%y")) %>%
  select(-DATESAMPLED, -COMMENTS, -SampleID, -ResultID, -ID, -OTHERID) %>%
  drop_na(CELLCOUNT) %>%
  filter(SITENAME == "LOCK 9" | 
           SITENAME == "YARRAWONGA" |
           SITENAME == "BURTUNDY" |
           SITENAME == "MERBEIN" |
           SITENAME == "SWAN HILL" |
           SITENAME == "BALRANALD" |
           SITENAME == "HEYWOODS" |
           SITENAME == "MORGAN") 

```

```{r}
a <- full_join(Phyto_AWQC, discharge_all)

b <- a %>%
  drop_na(Value)
df.combined <- b %>%
   drop_na(CELLCOUNT) %>%
  mutate(log_CELLCOUNT = log10(CELLCOUNT)) %>%
  mutate(log_Discharge = log10(Value))
```

This works for joining df's, however it drops Lock 9, variables musn't be named the same.

```{r}
df.combined %>%
  group_by(SITENAME, TAXA) %>%
  summarise(
    Cellcount = mean(CELLCOUNT),
    Discharge = mean(Value)
  )
```

```{r}
df.combined$Date_Sampled <- as.POSIXct(df.combined$Date_Sampled)
df.combined <- mutate(df.combined, MonthYear = paste(year(Date_Sampled), formatC(month(Date_Sampled), width = 2, flag = "0")))
df.combined <- mutate(df.combined, Week = week(Date_Sampled))
df.month_cell <- aggregate(df.combined$CELLCOUNT, by = list(df.combined$MonthYear), FUN = function(x) mean(x, na.rm=T))
df.month_discharge <- aggregate(df.combined$Value, by = list(df.combined$MonthYear), FUN = function(x) mean(x, na.rm=T))


  
```

### Subsetting for Presentation and ARIMAX
Now got a complete data set which contains indexed dates, discharge values, site names and cell counts. Unfortunately, once all this cleaning is done, we're left with a set of about 23,000 observations. 

Plots for each Site and total algae. 

```{r}
df.combined %>% 
  filter(SITENAME == "YARRAWONGA") %>%
  ggplot(aes(Date_Sampled, log_CELLCOUNT)) +
  geom_point() +
  scale_y_log10() + 
  labs(x = "Date",
       y = "Cellcount (cells/mL)",
       title = "Total Phytoplankton at Lock 9")
```


```{r}
p_yarra.xts <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")


pplot_yarra.xts<- xts(p_yarra.xts$log_CELLCOUNT, order.by = p_yarra.xts$Date_Sampled)
dygraph(pplot_yarra.xts, main = "Phytoplankton Abundance at Yarrawaonga", ylab = "Cells/mL")

d_yarra.xts <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")

dplot_yarra.xts <- xts(d_yarra.xts$log_Discharge, order.by = d_yarra.xts$Date_Sampled)
dygraph(dplot_yarra.xts, main = "Discharge at Yarrawonga", ylab = "Discharge [cumec]")
```

```{r}
df.combined %>%
  group_by(SITENAME) %>%
  summarise(
    n_distinct(TAXA),
    sum(CELLCOUNT)
  )

df.combined %>%
  group_by(TAXA) %>%
  summarise(
    sum(CELLCOUNT)
  )
```
Algae - total. 

```{r}
algae_df <- df.combined %>%
  filter(SITENAME == "LOCK 9",
          TAXA == "Algae - Total")
```


```{r}
p_algae.xts <- xts(algae_df$log_CELLCOUNT, order.by = algae_df$Date_Sampled)
d_algae.xts <- xts(algae_df$log_Discharge, order.by = algae_df$Date_Sampled)

pd_algae.xts <- cbind(p_algae.xts, d_algae.xts)

dygraph(p_algae.xts, main ="Phytoplankton")
dygraph(d_algae.xts, main = "Discharge")
```


```{r}
algae.ts <- algae_df %>%
  select(log_CELLCOUNT) %>%
  ts(start = c(1997,11), frequency = 80)

d_algae.ts <- algae_df %>%
  select(log_Discharge) %>%
  ts(start = c(1997,11), frequency =  80)

plot.ts(algae.ts)
plot.ts(d_algae.ts)

```


```{r}
farma <- function(algae.ts, h, d_algae.ts) {
  ncol <- NCOL(d_algae.ts)
  X <- matrix(xreg[seq_along(algae.ts), ], ncol = ncol)
  newX <- matrix(d_algae.ts[length(algae.ts) + seq(h), ], ncol = ncol)
  algae_m <- auto.arima(algae.ts, xreg = X)
  forecast(algae_m, xreg = newX, h = h)
}
```





### Heywoods - DONE 
```{r}
Heywoods.df <- df.combined %>%
  filter(SITENAME =="HEYWOODS")
min(Heywoods.df$Date_Sampled)
max(Heywoods.df$Date_Sampled)

Heywoods.df %>%
  group_by(TAXA) %>%
  summarise(CELLCOUNT) 

## Algae total, aulacoseira, b-g total 

heywoods_algae <- Heywoods.df %>%
  filter(TAXA =="Algae - Total")
    h_algae.ts <- ts(heywoods_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_algae_discharge <- ts(heywoods_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
heywoods_aulacoseira <- Heywoods.df %>%
  filter(TAXA == "Aulacoseira")
     h_aulacoseira.ts <- ts(heywoods_aulacoseira$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_aula_discharge <- ts(heywoods_aulacoseira$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
heywoods_bg <- Heywoods.df %>%
  filter(TAXA == "Blue Green Algae - Total")
    h_bg.ts <- ts(heywoods_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      h_bg_discharge <- ts(heywoods_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)


par(mfrow = c(1,3))
plot_algae <- plot(h_algae.ts)
plot_aulacoseira <- plot(h_aulacoseira.ts)
plot_bg <- plot(h_bg.ts)

par(mfrow = c(1,3))
plot_hd1 <- plot(h_algae_discharge)
plot_hd2 <- plot(h_aula_discharge)
plot_hd3 <- plot(h_bg_discharge)


```
###Yarrawonga - DONE
```{r}
Yarrawonga.df <- df.combined %>%
  filter(SITENAME == "YARRAWONGA")

min(Yarrawonga.df$Date_Sampled)
max(Yarrawonga.df$Date_Sampled)

Yarrawonga.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

# Algae total, aphanocapsa, aulacoeira, bg total
yarra_algae <- Yarrawonga.df %>%
  filter(TAXA =="Algae - Total")
    y_algae.ts <- ts(yarra_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_algae_discharge <- ts(yarra_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_aphanocapsa <- Yarrawonga.df %>%
  filter(TAXA =="Aphanocapsa")
    y_aphano.ts <- ts(yarra_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_aphanp_discharge <- ts(yarra_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_aula <- Yarrawonga.df %>%
  filter(TAXA =="Aulacoseira")
    y_aula.ts <- ts(yarra_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_aula_discharge <- ts(yarra_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
yarra_bg <- Yarrawonga.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    y_bg.ts <- ts(yarra_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      y_bg_discharge <- ts(yarra_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_y <- plot(y_algae.ts)
plot_aulacoseira_y <- plot(y_aula.ts)
plot_bg_y <- plot(y_bg.ts)
plot_aphano_y <- plot(y_aphano.ts)

par(mfrow = c(1,4))
plot_y1 <- plot(y_algae_discharge)
plot_y2 <- plot(y_aula_discharge)
plot_y3 <- plot(y_bg_discharge)
plot_y4 <- plot(y_aphanp_discharge)
```
###Merbein - DONE
```{r}
Merbein.df <- df.combined %>%
  filter(SITENAME == "MERBEIN")

min(Merbein.df$Date_Sampled)
max(Merbein.df$Date_Sampled)

Merbein.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

merbein_algae <- Merbein.df %>%
  filter(TAXA =="Algae - Total")
    m_algae.ts <- ts(merbein_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_algae_discharge <- ts(merbein_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_aphanocapsa <- Merbein.df %>%
  filter(TAXA =="Aphanocapsa")
    m_aphano.ts <- ts(merbein_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_aphanp_discharge <- ts(merbein_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_aula <- Merbein.df %>%
  filter(TAXA =="Aulacoseira")
    m_aula.ts <- ts(merbein_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_aula_discharge <- ts(merbein_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
merbein_bg <- Merbein.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    m_bg.ts <- ts(merbein_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      m_bg_discharge <- ts(merbein_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_m <- plot(m_algae.ts)
plot_aulacoseira_m <- plot(m_aula.ts)
plot_bg_m <- plot(m_bg.ts)
plot_aphano_m <- plot(m_aphano.ts)

par(mfrow = c(1,4))
plot_m1 <- plot(m_algae_discharge)
plot_m2 <- plot(m_aula_discharge)
plot_m3 <- plot(m_bg_discharge)
plot_m4 <- plot(m_aphanp_discharge)
```
###Swan Hill - DONE
```{r}
Swan_hill.df <- df.combined %>%
  filter(SITENAME == "SWAN HILL")

min(Swan_hill.df$Date_Sampled)
max(Swan_hill.df$Date_Sampled)

Swan_hill.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

swan_algae <- Swan_hill.df %>%
  filter(TAXA =="Algae - Total")
    s_algae.ts <- ts(swan_algae$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_algae_discharge <- ts(swan_algae$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
swan_aphanocapsa <- Swan_hill.df %>%
  filter(TAXA =="Aphanocapsa")
    s_aphano.ts <- ts(swan_aphanocapsa$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_aphanp_discharge <- ts(swan_aphanocapsa$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
swan_aula <- Swan_hill.df %>%
  filter(TAXA =="Aulacoseira")
    s_aula.ts <- ts(swan_aula$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_aula_discharge <- ts(swan_aula$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
s_bg <- Swan_hill.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    s_bg.ts <- ts(s_bg$CELLCOUNT, start = c(2016,7), end = c(2019,8), frequency = 80)
      s_bg_discharge <- ts(s_bg$Value, start = c(2016,7), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_s <- plot(s_algae.ts)
plot_aulacoseira_s <- plot(s_aula.ts)
plot_bg_s <- plot(s_bg.ts)
plot_aphano_s <- plot(s_aphano.ts)

par(mfrow = c(1,4))
plot_s1 <- plot(s_algae_discharge)
plot_s2 <- plot(s_aula_discharge)
plot_s3 <- plot(s_bg_discharge)
plot_s4 <- plot(s_aphanp_discharge)
```
### Lock 9 - DONE
```{r}
Lock9.df <- df.combined %>%
  filter(SITENAME == "LOCK 9")

min(Lock9.df$Date_Sampled)
max(Lock9.df$Date_Sampled)

Lock9.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

lock9_algae <- Lock9.df %>%
  filter(TAXA =="Algae - Total")
    l_algae.ts <- ts(lock9_algae$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_algae_discharge <- ts(lock9_algae$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_aphanocapsa <- Lock9.df %>%
  filter(TAXA =="Aphanocapsa")
    l_aphano.ts <- ts(lock9_aphanocapsa$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_aphanp_discharge <- ts(lock9_aphanocapsa$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_aula <- Lock9.df %>%
  filter(TAXA =="Aulacoseira")
    l_aula.ts <- ts(lock9_aula$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_aula_discharge <- ts(lock9_aula$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
lock9_bg <- Lock9.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    l_bg.ts <- ts(lock9_bg$CELLCOUNT, start = c(1997,11), end = c(2019,8), frequency = 80)
      l_bg_discharge <- ts(lock9_bg$Value, start = c(1997,11), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_l <- plot(l_algae.ts)
plot_aulacoseira_l <- plot(l_aula.ts)
plot_bg_l <- plot(l_bg.ts)
plot_aphano_l <- plot(l_aphano.ts)

par(mfrow = c(1,4))
plot_l1 <- plot(l_algae_discharge)
plot_l2 <- plot(l_aula_discharge)
plot_l3 <- plot(l_bg_discharge)
plot_l4 <- plot(l_aphanp_discharge)
```
###Balranald - DONE
```{r}
Balranald.df <- df.combined %>%
  filter(SITENAME == "BALRANALD")

min(Balranald.df$Date_Sampled)
max(Balranald.df$Date_Sampled)

Balranald.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

balranald_algae <- Balranald.df %>%
  filter(TAXA =="Algae - Total")
    b_algae.ts <- ts(balranald_algae$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_algae_discharge <- ts(balranald_algae$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_aphanocapsa <- Balranald.df %>%
  filter(TAXA =="Aphanocapsa")
    b_aphano.ts <- ts(balranald_aphanocapsa$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_aphanp_discharge <- ts(balranald_aphanocapsa$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_aula <- Balranald.df %>%
  filter(TAXA =="Aulacoseira")
    b_aula.ts <- ts(balranald_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_aula_discharge <- ts(balranald_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
balranald_bg <- Balranald.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    b_bg.ts <- ts(balranald_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      b_bg_discharge <- ts(balranald_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_b <- plot(b_algae.ts)
plot_aulacoseira_b <- plot(b_aula.ts)
plot_bg_b <- plot(b_bg.ts)
plot_aphano_b <- plot(b_aphano.ts)

par(mfrow = c(1,4))
plot_b1 <- plot(b_algae_discharge)
plot_b2 <- plot(b_aula_discharge)
plot_b3 <- plot(b_bg_discharge)
plot_b4 <- plot(b_aphanp_discharge)
```
### Burtrundy - DONE
```{r}
Burtundy.df <- df.combined %>%
  filter(SITENAME == "BURTUNDY")

min(Burtundy.df$Date_Sampled)
max(Burtundy.df$Date_Sampled)

Burtundy.df %>% 
  group_by(TAXA) %>%
  summarise(sum(CELLCOUNT))

burtundy_algae <- Burtundy.df %>%
  filter(TAXA =="Algae - Total")
    bt_algae.ts <- ts(burtundy_algae$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_algae_discharge <- ts(burtundy_algae$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_aphanocapsa <- Burtundy.df %>%
  filter(TAXA =="Aphanocapsa")
    bt_aphano.ts <- ts(burtundy_aphanocapsa$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_aphanp_discharge <- ts(burtundy_aphanocapsa$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_aula <- Burtundy.df %>%
  filter(TAXA =="Aulacoseira")
    bt_aula.ts <- ts(burtundy_aula$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_aula_discharge <- ts(burtundy_aula$Value, start = c(2016), end = c(2019,8), frequency = 80)
burtundy_bg <- Burtundy.df %>%
  filter(TAXA =="Blue Green Algae - Total")
    bt_bg.ts <- ts(burtundy_bg$CELLCOUNT, start = c(2016), end = c(2019,8), frequency = 80)
      bt_bg_discharge <- ts(burtundy_bg$Value, start = c(2016), end = c(2019,8), frequency = 80)
      
par(mfrow = c(1,4))
plot_algae_bt <- plot(bt_algae.ts)
plot_aulacoseira_bt <- plot(bt_aula.ts)
plot_bg_bt <- plot(bt_bg.ts)
plot_aphano_bt <- plot(bt_aphano.ts)

par(mfrow = c(1,4))
plot_bt1 <- plot(bt_algae_discharge)
plot_bt2 <- plot(bt_aula_discharge)
plot_bt3 <- plot(bt_bg_discharge)
plot_bt4 <- plot(bt_aphanp_discharge)
```

